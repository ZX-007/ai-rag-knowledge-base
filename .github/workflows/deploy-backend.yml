name: éƒ¨ç½²åç«¯åˆ°æœåŠ¡å™¨

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€ tag æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - 'v*.*.*'  # å¦‚ v1.0.0, v1.1.0, v2.0.0
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.1.0ï¼‰'
        required: true
        type: string
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'production'

env:
  DOCKER_IMAGE: white0618/ai-knowledge-base  # æ›¿æ¢ä¸ºä½ çš„ Docker Hub ç”¨æˆ·å/ä»“åº“å
  REGISTRY: docker.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: pro
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 2: è®¾ç½® Java ç¯å¢ƒ
      - name: è®¾ç½® Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      # æ­¥éª¤ 3: è·å–ç‰ˆæœ¬å·
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # ä» tag è·å–ç‰ˆæœ¬å·
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # ä»æ‰‹åŠ¨è¾“å…¥è·å–ç‰ˆæœ¬å·
            VERSION=${{ github.event.inputs.tag_version }}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${VERSION}"
      
      # æ­¥éª¤ 4: è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # æ­¥éª¤ 5: ç™»å½• Docker Hub
      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # æ­¥éª¤ 6: æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° Docker Hub
      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true  # ç›´æ¥æ¨é€åˆ° Docker Hub
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.get_version.outputs.VERSION }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # æ­¥éª¤ 7: å¤‡ä»½å’Œè®°å½•æœåŠ¡å™¨ä¸Šçš„å½“å‰ç‰ˆæœ¬
      - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬å’Œé…ç½®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_SERVER_HOST }}
          username: ${{ secrets.BACKEND_SERVER_USERNAME }}
          key: ${{ secrets.BACKEND_SERVER_SSH_KEY }}
          port: ${{ secrets.BACKEND_SERVER_PORT || 22 }}
          script: |
            DEPLOY_DIR="${{ secrets.BACKEND_DEPLOY_DIR }}"
            IMAGE_NAME="${{ env.DOCKER_IMAGE }}"
            
            cd "${DEPLOY_DIR}"
            mkdir -p images
            
            # è®°å½•å½“å‰ç‰ˆæœ¬
            if [ -f "docker-compose.yml" ]; then
              CURRENT_VERSION=$(grep "image: ${IMAGE_NAME}" docker-compose.yml | grep -oP '(?<=:)v[0-9]+\.[0-9]+\.[0-9]+' || echo "")
              if [ -n "$CURRENT_VERSION" ]; then
                echo "ğŸ“ è®°å½•å½“å‰è¿è¡Œç‰ˆæœ¬: ${CURRENT_VERSION}"
                echo "${CURRENT_VERSION}" > .current_version
            
                # å¤‡ä»½å½“å‰é…ç½®æ–‡ä»¶
                cp docker-compose.yml docker-compose.yml.backup
                echo "ğŸ’¾ é…ç½®æ–‡ä»¶å·²å¤‡ä»½"
            
                # å¤‡ä»½æ—§é•œåƒï¼ˆå¦‚æœè¿˜æ²¡æœ‰å¤‡ä»½ï¼‰
                BACKUP_FILE="images/${IMAGE_NAME##*/}_${CURRENT_VERSION}.tar.gz"
                if [ ! -f "$BACKUP_FILE" ]; then
                  echo "ğŸ’¾ å¤‡ä»½æ—§é•œåƒ ${CURRENT_VERSION}..."
                  docker save ${IMAGE_NAME}:${CURRENT_VERSION} | gzip > $BACKUP_FILE 2>/dev/null || echo "  æ—§é•œåƒå·²ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
                  if [ -f "$BACKUP_FILE" ]; then
                    echo "ğŸ’¾ å¤‡ä»½å¤§å°: $(du -h $BACKUP_FILE | cut -f1)"
                  fi
                else
                  echo "  æ—§é•œåƒå¤‡ä»½å·²å­˜åœ¨"
                fi
              else
                echo "â„¹ï¸ é¦–æ¬¡éƒ¨ç½²ï¼Œæ— å½“å‰ç‰ˆæœ¬"
              fi
            else
              echo "â„¹ï¸ docker-compose.yml ä¸å­˜åœ¨ï¼Œé¦–æ¬¡éƒ¨ç½²"
            fi
      
      # æ­¥éª¤ 8: ä¸Šä¼ æ–°çš„ docker-compose.yml
      - name: ä¸Šä¼  docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.BACKEND_SERVER_HOST }}
          username: ${{ secrets.BACKEND_SERVER_USERNAME }}
          key: ${{ secrets.BACKEND_SERVER_SSH_KEY }}
          port: ${{ secrets.BACKEND_SERVER_PORT || 22 }}
          source: "docker-compose.yml"
          target: ${{ secrets.BACKEND_DEPLOY_DIR }}
          strip_components: 0
          overwrite: true
      
      # æ­¥éª¤ 9: åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²
      - name: ä» Docker Hub æ‹‰å–é•œåƒå¹¶éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_SERVER_HOST }}
          username: ${{ secrets.BACKEND_SERVER_USERNAME }}
          key: ${{ secrets.BACKEND_SERVER_SSH_KEY }}
          port: ${{ secrets.BACKEND_SERVER_PORT || 22 }}
          script: |
            DEPLOY_DIR="${{ secrets.BACKEND_DEPLOY_DIR }}"
            VERSION="${{ steps.get_version.outputs.VERSION }}"
            IMAGE_NAME="${{ env.DOCKER_IMAGE }}"
            
            echo "=== å¼€å§‹éƒ¨ç½²åç«¯æœåŠ¡ ==="
            echo "éƒ¨ç½²ç›®å½•: ${DEPLOY_DIR}"
            echo "é•œåƒç‰ˆæœ¬: ${VERSION}"
            echo "é•œåƒåœ°å€: ${IMAGE_NAME}:${VERSION}"
            
            cd "${DEPLOY_DIR}"
            
            # 1. ä» Docker Hub æ‹‰å–æ–°é•œåƒ
            echo "ğŸ“¥ ä» Docker Hub æ‹‰å–æ–°é•œåƒ: ${VERSION}..."
            echo "â±ï¸ é•œåƒæ‹‰å–ä¸­ï¼Œæ—§æœåŠ¡ä»åœ¨è¿è¡Œï¼Œé›¶åœæœºæ—¶é—´..."
            docker pull ${IMAGE_NAME}:${VERSION}
            echo "âœ… é•œåƒæ‹‰å–å®Œæˆ"
            
            # 2. åœæ­¢æ—§æœåŠ¡
            if [ -f "docker-compose.yml.backup" ]; then
              echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
              docker compose -f docker-compose.yml.backup down
            fi
            
            # 3. æ›´æ–° docker-compose.yml ä¸­çš„é•œåƒç‰ˆæœ¬
            echo "ğŸ”§ æ›´æ–° docker-compose.yml é•œåƒç‰ˆæœ¬ä¸º: ${VERSION}"
            sed -i "s|image: ${IMAGE_NAME}:.*|image: ${IMAGE_NAME}:${VERSION}|g" docker-compose.yml
            
            # 4. å¤‡ä»½å¹¶æ›´æ–° .env æ–‡ä»¶ï¼ˆæ¯æ¬¡éƒ¨ç½²éƒ½æ›´æ–°ï¼‰
            if [ -f ".env" ]; then
              cp .env .env.backup
              echo "ğŸ’¾ .env æ–‡ä»¶å·²å¤‡ä»½"
            fi
            echo "ğŸ“ æ›´æ–° .env æ–‡ä»¶..."
            echo "DASHSCOPE_API_KEY=${{ secrets.DASHSCOPE_API_KEY }}" > .env
            chmod 600 .env
            echo "âœ… .env æ–‡ä»¶å·²æ›´æ–°"
            
            # 5. å¯åŠ¨æ–°ç‰ˆæœ¬æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æ–°ç‰ˆæœ¬æœåŠ¡..."
            docker compose up -d
            
            # 6. ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # 7. æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker compose ps
            
            # 8. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
            echo ""
            echo "ğŸ“‹ æœåŠ¡æ—¥å¿—:"
            docker compose logs --tail=12 ai-knowledge-base-app
            
            # 9. å¥åº·æ£€æŸ¥ï¼ˆç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ªï¼‰
            echo ""
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            
            # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
            if docker ps | grep -q ai-knowledge-base-app; then
              echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"
            
              # ç­‰å¾…å¥åº·æ£€æŸ¥ç«¯ç‚¹å°±ç»ªï¼ˆæœ€å¤šç­‰å¾…2åˆ†é’Ÿï¼‰
              MAX_RETRIES=60
              RETRY_COUNT=0
            
              echo "â³ ç­‰å¾…å¥åº·æ£€æŸ¥ç«¯ç‚¹å°±ç»ª..."
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                  # è·å–å¥åº·çŠ¶æ€
                  HEALTH_STATUS=$(curl -s http://localhost:8080/actuator/health | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "UNKNOWN")
            
                  if [ "$HEALTH_STATUS" == "UP" ]; then
                    echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡: çŠ¶æ€ UP"
            
                    # æ£€æŸ¥å°±ç»ªæ¢é’ˆ
                    if curl -f http://localhost:8080/actuator/health/readiness > /dev/null 2>&1; then
                      echo "âœ… Readiness æ¢é’ˆ: æœåŠ¡å·²å°±ç»ª"
                    fi
            
                    # æ£€æŸ¥å­˜æ´»æ¢é’ˆ
                    if curl -f http://localhost:8080/actuator/health/liveness > /dev/null 2>&1; then
                      echo "âœ… Liveness æ¢é’ˆ: æœåŠ¡å­˜æ´»"
                    fi
            
                    break
                  else
                    echo "âš ï¸ å¥åº·çŠ¶æ€: $HEALTH_STATUS (ç­‰å¾…ä¸­...)"
                  fi
                fi
            
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 2
              done
            
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶ï¼ˆ2åˆ†é’Ÿï¼‰"
                echo "æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š"
                docker compose logs --tail=50 ai-knowledge-base-app
            
                # è§¦å‘å›æ»š

                echo "ğŸ”„ å¼€å§‹è‡ªåŠ¨å›æ»š..."
            
                # è¯»å–ä¹‹å‰çš„ç‰ˆæœ¬
                if [ -f ".current_version" ]; then
                  ROLLBACK_VERSION=$(cat .current_version)
                  echo "å›æ»šåˆ°ç‰ˆæœ¬: ${ROLLBACK_VERSION}"
            
                  # åœæ­¢å¤±è´¥çš„æœåŠ¡
                  docker compose down -v
            
                  # æ¢å¤é…ç½®æ–‡ä»¶
                  if [ -f "docker-compose.yml.backup" ]; then
                    mv docker-compose.yml.backup docker-compose.yml
                    echo "âœ… é…ç½®æ–‡ä»¶å·²æ¢å¤"
                  fi
                  
                  # æ¢å¤ .env æ–‡ä»¶
                  if [ -f ".env.backup" ]; then
                    mv .env.backup .env
                    echo "âœ… .env æ–‡ä»¶å·²æ¢å¤"
                  fi
            
                  # å¯åŠ¨æ—§ç‰ˆæœ¬æœåŠ¡
                  docker compose up -d
            
                  # ç­‰å¾…å¹¶éªŒè¯
                  sleep 10
                  if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                    echo "âœ… å›æ»šæˆåŠŸï¼æœåŠ¡å·²æ¢å¤åˆ°ç‰ˆæœ¬: ${ROLLBACK_VERSION}"
                  else
                    echo "âŒ å›æ»šå¤±è´¥ï¼è¯·æ‰‹åŠ¨ä»‹å…¥"
                  fi
                else
                  echo "âš ï¸ æ— æ³•å›æ»šï¼šæ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ä¿¡æ¯"
                fi
            
                exit 1
              fi
            else
              echo "âŒ å®¹å™¨æœªè¿è¡Œï¼Œè§¦å‘å›æ»š..."
            
              # å›æ»šé€»è¾‘
              if [ -f ".current_version" ] && [ -f "docker-compose.yml.backup" ]; then
                ROLLBACK_VERSION=$(cat .current_version)
                echo "ğŸ”„ å›æ»šåˆ°ç‰ˆæœ¬: ${ROLLBACK_VERSION}"
            
                # æ¢å¤é…ç½®æ–‡ä»¶
                mv docker-compose.yml.backup docker-compose.yml
                
                # æ¢å¤ .env æ–‡ä»¶
                if [ -f ".env.backup" ]; then
                  mv .env.backup .env
                fi
                
                docker compose up -d
            
                sleep 10
                if docker ps | grep -q ai-knowledge-base-app; then
                  echo "âœ… å›æ»šæˆåŠŸï¼"
                else
                  echo "âŒ å›æ»šå¤±è´¥ï¼"
                fi
              fi
            
              exit 1
            fi
            
            # 9. æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼ˆéƒ¨ç½²æˆåŠŸåï¼‰
            echo ""
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„æ—§é•œåƒ..."
            docker image prune -f
            
            # 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶å¤‡ä»½æ–‡ä»¶..."
            rm -f .current_version docker-compose.yml.backup .env.backup
            
            echo ""
            echo "=== éƒ¨ç½²å®Œæˆï¼ ==="
            echo "é•œåƒç‰ˆæœ¬: ${IMAGE_NAME}:${VERSION}"
            echo "å®¹å™¨åç§°: ai-knowledge-base-app"
            echo "ç«¯å£æ˜ å°„: 8080:8080"
            echo "âœ… æ–°ç‰ˆæœ¬å·²æˆåŠŸéƒ¨ç½²å¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
      
      # æ­¥éª¤ 10: éªŒè¯éƒ¨ç½²
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ° Docker Hub: ${{ env.DOCKER_IMAGE }}:${{ steps.get_version.outputs.VERSION }}"
          echo "ğŸš€ æœåŠ¡å·²åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨ï¼ˆä» Docker Hub æ‹‰å–ï¼‰"
      
      # æ­¥éª¤ 11: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ åç«¯éƒ¨ç½²æˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.VERSION }}"
          echo "é•œåƒ: ${{ env.DOCKER_IMAGE }}:${{ steps.get_version.outputs.VERSION }}"
          echo "é•œåƒä»“åº“: Docker Hub"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
      
      # æ­¥éª¤ 12: éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ åç«¯éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"

