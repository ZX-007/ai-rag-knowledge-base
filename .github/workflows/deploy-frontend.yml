name: éƒ¨ç½²å‰ç«¯åˆ°æœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šä»…å½“ frontend ç›®å½•æœ‰å˜åŒ–æ—¶
on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'  # ä»…ç›‘å¬ frontend ç›®å½•
      - '.github/workflows/deploy-frontend.yml'  # ç›‘å¬è‡ªèº«å˜åŒ–
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    environment: pro  # ä½¿ç”¨ pro ç¯å¢ƒçš„ secrets
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        working-directory: ./frontend
        run: npm ci
      
      # æ­¥éª¤ 4: è¿è¡Œæµ‹è¯•
      - name: è¿è¡Œæµ‹è¯•
        working-directory: ./frontend
        run: npm test
      
      # æ­¥éª¤ 5: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      - name: æ„å»ºå‰ç«¯
        working-directory: ./frontend
        run: npm run build
      
      # æ­¥éª¤ 6: æ˜¾ç¤ºæ„å»ºäº§ç‰©
      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©
        working-directory: ./frontend
        run: |
          echo "æ„å»ºå®Œæˆï¼äº§ç‰©åˆ—è¡¨ï¼š"
          ls -lah dist/
          du -sh dist/
      
      # æ­¥éª¤ 7: å‹ç¼©æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼ŒåŠ å¿«ä¼ è¾“ï¼‰
      - name: å‹ç¼©æ„å»ºäº§ç‰©
        working-directory: ./frontend
        run: |
          tar -czf dist.tar.gz dist/
          ls -lh dist.tar.gz
      
      # æ­¥éª¤ 8: é€šè¿‡ SSH éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONTEND_SERVER_HOST }}
          username: ${{ secrets.FRONTEND_SERVER_USERNAME }}
          key: ${{ secrets.FRONTEND_SERVER_SSH_KEY }}
          port: ${{ secrets.FRONTEND_SERVER_PORT || 22 }}
          source: "frontend/dist.tar.gz"
          target: ${{ secrets.FRONTEND_DEPLOY_DIR }}
          strip_components: 1
      
      # æ­¥éª¤ 9: åœ¨æœåŠ¡å™¨ä¸Šè§£å‹å¹¶éƒ¨ç½²
      - name: è§£å‹å¹¶éƒ¨ç½²åˆ°ç›®æ ‡ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_SERVER_HOST }}
          username: ${{ secrets.FRONTEND_SERVER_USERNAME }}
          key: ${{ secrets.FRONTEND_SERVER_SSH_KEY }}
          port: ${{ secrets.FRONTEND_SERVER_PORT || 22 }}
          script: |
            # è®¾ç½®ç›®æ ‡éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="${{ secrets.FRONTEND_DEPLOY_DIR }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "=== å¼€å§‹éƒ¨ç½²å‰ç«¯ ==="
            echo "éƒ¨ç½²ç›®å½•: ${DEPLOY_DIR}"
            
            # è¿›å…¥éƒ¨ç½²ç›®å½•
            cd "${DEPLOY_DIR}"
            
            # åˆ›å»º html ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p html
            
            # è§£å‹æ–°ç‰ˆæœ¬åˆ° html ç›®å½•
            echo "è§£å‹æ–°ç‰ˆæœ¬åˆ° html ç›®å½•..."
            tar -xzf dist.tar.gz
            
            # åˆ é™¤ html ç›®å½•å†…å®¹å¹¶å¤åˆ¶æ–°æ–‡ä»¶
            echo "éƒ¨ç½²æ–°æ–‡ä»¶..."
            rm -rf html/*
            cp -r dist/* html/
            
            # åˆ é™¤è§£å‹çš„ä¸´æ—¶ dist ç›®å½•
            rm -rf dist
            
            # é‡å‘½åå‹ç¼©æ–‡ä»¶ï¼Œæ·»åŠ æ—¶é—´æˆ³åç¼€
            echo "ä¿å­˜å‹ç¼©æ–‡ä»¶: dist_${TIMESTAMP}.tar.gz"
            mv dist.tar.gz dist_${TIMESTAMP}.tar.gz
            
            # è®¾ç½®æƒé™
            echo "è®¾ç½®æ–‡ä»¶æƒé™..."
            chown -R www-data:www-data html/ || true
            chmod -R 755 html/
            
            echo "=== éƒ¨ç½²å®Œæˆï¼ ==="
            echo "å½“å‰éƒ¨ç½²ç›®å½•å†…å®¹ï¼š"
            ls -lah "${DEPLOY_DIR}"
            echo ""
            echo "html ç›®å½•å†…å®¹ï¼š"
            ls -lah "${DEPLOY_DIR}/html"
      
      # æ­¥éª¤ 10: éªŒè¯éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "éªŒè¯éƒ¨ç½²..."
          # æ£€æŸ¥æœåŠ¡å™¨å“åº”ï¼ˆå¦‚æœæœ‰åŸŸåï¼‰
          # curl -f https://your-domain.com || exit 1
          echo "âœ… éƒ¨ç½²éªŒè¯é€šè¿‡"
      
      # æ­¥éª¤ 11: å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ å‰ç«¯éƒ¨ç½²æˆåŠŸï¼"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo "æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
      
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"

